on:
  push:
    branches:
      - nixos-**
      - nixpkgs-**

jobs:
  find-and-replace-job:
    runs-on: ubuntu-latest
    name: 'Push'
    permissions:
      id-token: "write"
      contents: "read"
    steps:

      - name: Version - Remove nixpkgs-
        uses: mad9000/actions-find-and-replace-string@3
        id: branch_no_nixpkgs_prefix
        with:
          source: ${{ github.ref_name }}
          find: 'nixpkgs-'
          replace: ''
      - name: Version - Remove nixos-
        uses: mad9000/actions-find-and-replace-string@3
        id: branch_no_nixos_prefix
        with:
          source: ${{ steps.branch_no_nixpkgs_prefix.outputs.value }}
          find: 'nixos-'
          replace: ''
      - name: Version - Remove -small
        uses: mad9000/actions-find-and-replace-string@3
        id: branch_no_small_suffix
        with:
          source: ${{ steps.branch_no_nixos_prefix.outputs.value }}
          find: '-small'
          replace: ''
      - name: Version - Remove -darwin
        uses: mad9000/actions-find-and-replace-string@3
        id: branch_no_darwin_suffix
        with:
          source: ${{ steps.branch_no_small_suffix.outputs.value }}
          find: '-darwin'
          replace: ''
      - name: Version - Remove `.`s
        uses: mad9000/actions-find-and-replace-string@3
        id: minor_string_approximate
        with:
          source: ${{ steps.branch_no_darwin_suffix.outputs.value }}
          find: '.'
          replace: ''
      - name: Version - Replace `unstable` with `1`
        uses: mad9000/actions-find-and-replace-string@3
        id: minor_version
        with:
          source: ${{ steps.minor_string_approximate.outputs.value }}
          find: 'unstable'
          replace: '1'

      - uses: "actions/checkout@v3"
      - uses: "DeterminateSystems/nix-installer-action@main"
      - uses: "DeterminateSystems/magic-nix-cache-action@main"
      - uses: "DeterminateSystems/flakehub-push@main"
        with:
          name: NixOS/nixpkgs${{((endsWith(matrix.branch, '-small') && '-small') || (endsWith(matrix.branch, '-darwin') && '-darwin') || ((matrix.branch == 'nixpkgs-unstable') && '-unstable') || '')}}
          visibility: public
          rolling: true
          rolling-minor: ${{ steps.minor_version.outputs.value }}
